# 1.微信开发
## 1.1 公众号接口权限
<table>
    <tr>
        <td>接口名称</td>
        <td>未认证订阅号</td>
        <td>微信认证订阅号</td>
        <td>未认证服务号</td>
        <td>微信认证服务号</td>
    </tr>
    <tr>
        <td>基础支持-获取access_token</td>
        <td>有</td>
        <td>有</td>
        <td>有</td>
        <td>有</td>
    </tr>
    <tr>
        <td>基础支持-获取微信服务器IP地址</td>
        <td>有</td>
        <td>有</td>
        <td>有</td>
        <td>有</td>
    </tr>
    <tr>
        <td>接收消息-验证消息真实性、接收普通消息、接收事件推送、接收语音识别结果</td>
        <td>有</td>
        <td>有</td>
        <td>有</td>
        <td>有</td>
    </tr>
    <tr>
        <td>发送消息-被动回复消息</td>
        <td>有</td>
        <td>有</td>
        <td>有</td>
        <td>有</td>
    </tr>
    <tr>
        <td>发送消息-客服接口</td>
        <td></td>
        <td>有</td>
        <td></td>
        <td>有</td>
    </tr>
    <tr>
        <td>发送消息-群发接口</td>
        <td></td>
        <td>有</td>
        <td></td>
        <td>有</td>
    </tr>
    <tr>
        <td>发送消息-模板消息接口（发送业务通知）</td>
        <td></td>
        <td></td>
        <td></td>
        <td>有</td>
    </tr>
    <tr>
        <td>用户管理-用户分组管理</td>
        <td></td>
        <td>有</td>
        <td></td>
        <td>有</td>
    </tr>
    <tr>
        <td>用户管理-设置用户备注名</td>
        <td></td>
        <td>有</td>
        <td></td>
        <td>有</td>
    </tr>
    <tr>
        <td>用户管理-获取用户基本信息</td>
        <td></td>
        <td>有</td>
        <td></td>
        <td>有</td>
    </tr>
    <tr>
        <td>用户管理-获取用户列表</td>
        <td></td>
        <td>有</td>
        <td></td>
        <td>有</td>
    </tr>
    <tr>
        <td>用户管理-获取用户地理位置</td>
        <td></td>
        <td></td>
        <td></td>
        <td>有</td>
    </tr>
    <tr>
        <td>用户管理-网页授权获取用户openid/用户基本信息</td>
        <td></td>
        <td></td>
        <td></td>
        <td>有</td>
    </tr>
    <tr>
        <td>推广支持-生成带参数二维码</td>
        <td></td>
        <td></td>
        <td></td>
        <td>有</td>
    </tr>
    <tr>
        <td>推广支持-长链接转短链接口</td>
        <td></td>
        <td></td>
        <td></td>
        <td>有</td>
    </tr>
    <tr>
        <td>界面丰富-自定义菜单</td>
        <td></td>
        <td>有</td>
        <td>有</td>
        <td>有</td>
    </tr>
    <tr>
        <td>素材管理-素材管理接口</td>
        <td></td>
        <td>有</td>
        <td></td>
        <td>有</td>
    </tr>
    <tr>
        <td>智能接口-语义理解接口</td>
        <td></td>
        <td></td>
        <td></td>
        <td>有</td>
    </tr>
    <tr>
        <td>多客服-获取多客服消息记录、客服管理</td>
        <td></td>
        <td></td>
        <td></td>
        <td>有</td>
    </tr>
    <tr>
        <td>微信支付接口</td>
        <td></td>
        <td></td>
        <td></td>
        <td>需申请</td>
    </tr>
    <tr>
        <td>微信小店接口</td>
        <td></td>
        <td></td>
        <td></td>
        <td>需申请</td>
    </tr>
    <tr>
        <td>微信卡券接口</td>
        <td></td>
        <td>需申请</td>
        <td></td>
        <td>需申请</td>
    </tr>
    <tr>
        <td>微信设备功能接口</td>
        <td></td>
        <td></td>
        <td></td>
        <td>需申请</td>
    </tr>
    <tr>
        <td>微信JS-SDK-基础接口</td>
        <td>有</td>
        <td>有</td>
        <td>有</td>
        <td>有</td>
    </tr>
    <tr>
        <td>微信JS-SDK-分享接口</td>
        <td></td>
        <td>有</td>
        <td></td>
        <td>有</td>
    </tr>
    <tr>
        <td>微信JS-SDK-图像接口</td>
        <td>有</td>
        <td>有</td>
        <td>有</td>
        <td>有</td>
    </tr>
    <tr>
        <td>微信JS-SDK-音频接口</td>
        <td>有</td>
        <td>有</td>
        <td>有</td>
        <td>有</td>
    </tr>
    <tr>
        <td>微信JS-SDK-智能接口（网页语音识别）</td>
        <td>有</td>
        <td>有</td>
        <td>有</td>
        <td>有</td>
    </tr>
    <tr>
        <td>微信JS-SDK-设备信息</td>
        <td>有</td>
        <td>有</td>
        <td>有</td>
        <td>有</td>
    </tr>
    <tr>
        <td>微信JS-SDK-地理位置</td>
        <td>有</td>
        <td>有</td>
        <td>有</td>
        <td>有</td>
    </tr>
    <tr>
        <td>微信JS-SDK-界面操作</td>
        <td>有</td>
        <td>有</td>
        <td>有</td>
        <td>有</td>
    </tr>
    <tr>
        <td>微信JS-SDK-微信扫一扫</td>
        <td>有</td>
        <td>有</td>
        <td>有</td>
        <td>有</td>
    </tr>
    <tr>
        <td>微信JS-SDK-微信小店</td>
        <td></td>
        <td></td>
        <td></td>
        <td>有</td>
    </tr>
    <tr>
        <td>微信JS-SDK-微信卡券</td>
        <td></td>
        <td>有</td>
        <td></td>
        <td>有</td>
    </tr>
    <tr>
        <td>微信JS-SDK-微信支付</td>
        <td></td>
        <td></td>
        <td></td>
        <td>有</td>
    </tr>
</table>

## 1.2 公众号接口返回码
公众号每次调用接口时，可能获得正确或错误的返回码，开发者可以根据返回码信息调试接口，排查错误。

<table>
    <tr>
        <td>返回码</td>
        <td>说明</td>
    </tr>
    <tr>
        <td>-1</td>
        <td>系统繁忙，此时请开发者稍候再试</td>
    </tr>
    <tr>
        <td>0</td>
        <td>请求成功</td>
    </tr>
    <tr>
        <td>40001</td>
        <td>获取access_token时AppSecret错误，或者access_token无效。请开发者认真比对AppSecret的正确性，或查看是否正在为恰当的公众号调用接口</td>
    </tr>
    <tr>
        <td>40002</td>
        <td>不合法的凭证类型</td>
    </tr>
    <tr>
        <td>40003</td>
        <td>不合法的OpenID，请开发者确认OpenID（该用户）是否已关注公众号，或是否是其他公众号的OpenID</td>
    </tr>
    <tr>
        <td>40004</td>
        <td>不合法的媒体文件类型</td>
    </tr>
    <tr>
        <td>40005</td>
        <td>不合法的文件类型</td>
    </tr>
    <tr>
        <td>40006</td>
        <td>不合法的文件大小</td>
    </tr>
    <tr>
        <td>40007</td>
        <td>不合法的媒体文件id</td>
    </tr>
    <tr>
        <td>40008</td>
        <td>不合法的消息类型</td>
    </tr>
    <tr>
        <td>40009</td>
        <td>不合法的图片文件大小</td>
    </tr>
    <tr>
        <td>40010</td>
        <td>不合法的语音文件大小</td>
    </tr>
    <tr>
        <td>40011</td>
        <td>不合法的视频文件大小</td>
    </tr>
    <tr>
        <td>40012</td>
        <td>不合法的缩略图文件大小</td>
    </tr>
    <tr>
        <td>40013</td>
        <td>不合法的AppID，请开发者检查AppID的正确性，避免异常字符，注意大小写</td>
    </tr>
    <tr>
        <td>40014</td>
        <td>不合法的access_token，请开发者认真比对access_token的有效性（如是否过期），或查看是否正在为恰当的公众号调用接口</td>
    </tr>
    <tr>
        <td>40015</td>
        <td>不合法的菜单类型</td>
    </tr>
    <tr>
        <td>40016</td>
        <td>不合法的按钮个数</td>
    </tr>
    <tr>
        <td>40017</td>
        <td>不合法的按钮个数</td>
    </tr>
    <tr>
        <td>40018</td>
        <td>不合法的按钮名字长度</td>
    </tr>
    <tr>
        <td>40019</td>
        <td>不合法的按钮KEY长度</td>
    </tr>
    <tr>
        <td>40020</td>
        <td>不合法的按钮URL长度</td>
    </tr>
    <tr>
        <td>40021</td>
        <td>不合法的菜单版本号</td>
    </tr>
    <tr>
        <td>40022</td>
        <td>不合法的子菜单级数</td>
    </tr>
    <tr>
        <td>40023</td>
        <td>不合法的子菜单按钮个数</td>
    </tr>
    <tr>
        <td>40024</td>
        <td>不合法的子菜单按钮类型</td>
    </tr>
    <tr>
        <td>40025</td>
        <td>不合法的子菜单按钮名字长度</td>
    </tr>
    <tr>
        <td>40026</td>
        <td>不合法的子菜单按钮KEY长度</td>
    </tr>
    <tr>
        <td>40027</td>
        <td>不合法的子菜单按钮URL长度</td>
    </tr>
    <tr>
        <td>40028</td>
        <td>不合法的自定义菜单使用用户</td>
    </tr>
    <tr>
        <td>40029</td>
        <td>不合法的oauth_code</td>
    </tr>
    <tr>
        <td>40030</td>
        <td>不合法的refresh_token</td>
    </tr>
    <tr>
        <td>40031</td>
        <td>不合法的openid列表</td>
    </tr>
    <tr>
        <td>40032</td>
        <td>不合法的openid列表长度</td>
    </tr>
    <tr>
        <td>40033</td>
        <td>不合法的请求字符，不能包含\uxxxx格式的字符</td>
    </tr>
    <tr>
        <td>40035</td>
        <td>不合法的参数</td>
    </tr>
    <tr>
        <td>40038</td>
        <td>不合法的请求格式</td>
    </tr>
    <tr>
        <td>40039</td>
        <td>不合法的URL长度</td>
    </tr>
    <tr>
        <td>40050</td>
        <td>不合法的分组id</td>
    </tr>
    <tr>
        <td>40051</td>
        <td>分组名字不合法</td>
    </tr>
    <tr>
        <td>40117</td>
        <td>分组名字不合法</td>
    </tr>
    <tr>
        <td>40118</td>
        <td>media_id大小不合法</td>
    </tr>
    <tr>
        <td>40119</td>
        <td>button类型错误</td>
    </tr>
    <tr>
        <td>40120</td>
        <td>button类型错误</td>
    </tr>
    <tr>
        <td>40121</td>
        <td>不合法的media_id类型</td>
    </tr>
    <tr>
        <td>40132</td>
        <td>微信号不合法</td>
    </tr>
    <tr>
        <td>40137</td>
        <td>不支持的图片格式</td>
    </tr>
    <tr>
        <td>41001</td>
        <td>缺少access_token参数</td>
    </tr>
    <tr>
        <td>41002</td>
        <td>缺少appid参数</td>
    </tr>
    <tr>
        <td>41003</td>
        <td>缺少refresh_token参数</td>
    </tr>
    <tr>
        <td>41004</td>
        <td>缺少secret参数</td>
    </tr>
    <tr>
        <td>41005</td>
        <td>缺少多媒体文件数据</td>
    </tr>
    <tr>
        <td>41006</td>
        <td>缺少media_id参数</td>
    </tr>
    <tr>
        <td>41007</td>
        <td>缺少子菜单数据</td>
    </tr>
    <tr>
        <td>41008</td>
        <td>缺少oauth code</td>
    </tr>
    <tr>
        <td>41009</td>
        <td>缺少openid</td>
    </tr>
    <tr>
        <td>42001</td>
        <td>access_token超时，请检查access_token的有效期，请参考基础支持-获取access_token中，对access_token的详细机制说明</td>
    </tr>
    <tr>
        <td>42002</td>
        <td>refresh_token超时</td>
    </tr>
    <tr>
        <td>42003</td>
        <td>oauth_code超时</td>
    </tr>
    <tr>
        <td>42007</td>
        <td>用户修改微信密码，accesstoken和refreshtoken失效，需要重新授权</td>
    </tr>
    <tr>
        <td>43001</td>
        <td>需要GET请求</td>
    </tr>
    <tr>
        <td>43002</td>
        <td>需要POST请求</td>
    </tr>
    <tr>
        <td>43003</td>
        <td>需要HTTPS请求</td>
    </tr>
    <tr>
        <td>43004</td>
        <td>需要接收者关注</td>
    </tr>
    <tr>
        <td>43005</td>
        <td>需要好友关系</td>
    </tr>
    <tr>
        <td>44001</td>
        <td>多媒体文件为空</td>
    </tr>
    <tr>
        <td>44002</td>
        <td>POST的数据包为空</td>
    </tr>
    <tr>
        <td>44003</td>
        <td>图文消息内容为空</td>
    </tr>
    <tr>
        <td>44004</td>
        <td>文本消息内容为空</td>
    </tr>
    <tr>
        <td>45001</td>
        <td>多媒体文件大小超过限制</td>
    </tr>
    <tr>
        <td>45002</td>
        <td>消息内容超过限制</td>
    </tr>
    <tr>
        <td>45003</td>
        <td>标题字段超过限制</td>
    </tr>
    <tr>
        <td>45004</td>
        <td>描述字段超过限制</td>
    </tr>
    <tr>
        <td>45005</td>
        <td>链接字段超过限制</td>
    </tr>
    <tr>
        <td>45006</td>
        <td>图片链接字段超过限制</td>
    </tr>
    <tr>
        <td>45007</td>
        <td>语音播放时间超过限制</td>
    </tr>
    <tr>
        <td>45008</td>
        <td>图文消息超过限制</td>
    </tr>
    <tr>
        <td>45009</td>
        <td>接口调用超过限制</td>
    </tr>
    <tr>
        <td>45010</td>
        <td>创建菜单个数超过限制</td>
    </tr>
    <tr>
        <td>45015</td>
        <td>回复时间超过限制</td>
    </tr>
    <tr>
        <td>45016</td>
        <td>系统分组，不允许修改</td>
    </tr>
    <tr>
        <td>45017</td>
        <td>分组名字过长</td>
    </tr>
    <tr>
        <td>45018</td>
        <td>分组数量超过上限</td>
    </tr>
    <tr>
        <td>45047</td>
        <td>客服接口下行条数超过上限</td>
    </tr>
    <tr>
        <td>46001</td>
        <td>不存在媒体数据</td>
    </tr>
    <tr>
        <td>46002</td>
        <td>不存在的菜单版本</td>
    </tr>
    <tr>
        <td>46003</td>
        <td>不存在的菜单数据</td>
    </tr>
    <tr>
        <td>46004</td>
        <td>不存在的用户</td>
    </tr>
    <tr>
        <td>47001</td>
        <td>解析JSON/XML内容错误</td>
    </tr>
    <tr>
        <td>48001</td>
        <td>api功能未授权，请确认公众号已获得该接口，可以在公众平台官网-开发者中心页中查看接口权限</td>
    </tr>
    <tr>
        <td>48004</td>
        <td>api接口被封禁，请登录mp.weixin.qq.com查看详情</td>
    </tr>
    <tr>
        <td>50001</td>
        <td>用户未授权该api</td>
    </tr>
    <tr>
        <td>50002</td>
        <td>用户受限，可能是违规后接口被封禁</td>
    </tr>
    <tr>
        <td>61451</td>
        <td>参数错误(invalid parameter)</td>
    </tr>
    <tr>
        <td>61452</td>
        <td>无效客服账号(invalid kf_account)</td>
    </tr>
    <tr>
        <td>61453</td>
        <td>客服帐号已存在(kf_account exsited)</td>
    </tr>
    <tr>
        <td>61454</td>
        <td>客服帐号名长度超过限制(仅允许10个英文字符，不包括@及@后的公众号的微信号)(invalid kf_acount length)</td>
    </tr>
    <tr>
        <td>61455</td>
        <td>客服帐号名包含非法字符(仅允许英文+数字)(illegal character in kf_account)</td>
    </tr>
    <tr>
        <td>61456</td>
        <td>客服帐号个数超过限制(10个客服账号)(kf_account count exceeded)(invalid kf_account)</td>
    </tr>
    <tr>
        <td>61457</td>
        <td>无效头像文件类型(invalid file type)</td>
    </tr>
    <tr>
        <td>61450</td>
        <td>系统错误(system error)</td>
    </tr>
    <tr>
        <td>61500</td>
        <td>日期格式错误</td>
    </tr>
    <tr>
        <td>65301</td>
        <td>不存在此menuid对应的个性化菜单</td>
    </tr>
    <tr>
        <td>65302</td>
        <td>没有相应的用户</td>
    </tr>
    <tr>
        <td>65303</td>
        <td>没有默认菜单，不能创建个性化菜单</td>
    </tr>
    <tr>
        <td>65304</td>
        <td>MatchRule信息为空</td>
    </tr>
    <tr>
        <td>65305</td>
        <td>个性化菜单数量受限</td>
    </tr>
    <tr>
        <td>65306</td>
        <td>不支持个性化菜单的帐号</td>
    </tr>
    <tr>
        <td>65307</td>
        <td>个性化菜单信息为空</td>
    </tr>
    <tr>
        <td>65308</td>
        <td>包含没有响应类型的button</td>
    </tr>
    <tr>
        <td>65309</td>
        <td>个性化菜单开关处于关闭状态</td>
    </tr>
    <tr>
        <td>65310</td>
        <td>填写了省份或城市信息，国家信息不能为空</td>
    </tr>
    <tr>
        <td>65311</td>
        <td>填写了城市信息，省份信息不能为空</td>
    </tr>
    <tr>
        <td>65312</td>
        <td>不合法的国家信息</td>
    </tr>
    <tr>
        <td>65313</td>
        <td>不合法的省份信息</td>
    </tr>
    <tr>
        <td>65314</td>
        <td>不合法的城市信息</td>
    </tr>
    <tr>
        <td>65316</td>
        <td>该公众号的菜单设置了过多的域名外跳（最多跳转到3个域名的链接）</td>
    </tr>
    <tr>
        <td>65317</td>
        <td>不合法的URL</td>
    </tr>
    <tr>
        <td>9001001</td>
        <td>POST数据参数不合法</td>
    </tr>
    <tr>
        <td>9001002</td>
        <td>远端服务不可用</td>
    </tr>
    <tr>
        <td>9001003</td>
        <td>Ticket不合法</td>
    </tr>
    <tr>
        <td>9001004</td>
        <td>获取摇周边用户信息失败</td>
    </tr>
    <tr>
        <td>9001005</td>
        <td>获取商户信息失败</td>
    </tr>
    <tr>
        <td>9001006</td>
        <td>获取OpenID失败</td>
    </tr>
    <tr>
        <td>9001007</td>
        <td>上传文件缺失</td>
    </tr>
    <tr>
        <td>9001008</td>
        <td>上传素材的文件类型不合法</td>
    </tr>
    <tr>
        <td>9001009</td>
        <td>上传素材的文件尺寸不合法</td>
    </tr>
    <tr>
        <td>9001010</td>
        <td>上传失败</td>
    </tr>
    <tr>
        <td>9001020</td>
        <td>帐号不合法</td>
    </tr>
    <tr>
        <td>9001021</td>
        <td>已有设备激活率低于50%，不能新增设备</td>
    </tr>
    <tr>
        <td>9001022</td>
        <td>设备申请数不合法，必须为大于0的数字</td>
    </tr>
    <tr>
        <td>9001023</td>
        <td>已存在审核中的设备ID申请</td>
    </tr>
    <tr>
        <td>9001024</td>
        <td>一次查询设备ID数量不能超过50</td>
    </tr>
    <tr>
        <td>9001025</td>
        <td>设备ID不合法</td>
    </tr>
    <tr>
        <td>9001026</td>
        <td>页面ID不合法</td>
    </tr>
    <tr>
        <td>9001027</td>
        <td>页面参数不合法</td>
    </tr>
    <tr>
        <td>9001028</td>
        <td>一次删除页面ID数量不能超过10</td>
    </tr>
    <tr>
        <td>9001029</td>
        <td>页面已应用在设备中，请先解除应用关系再删除</td>
    </tr>
    <tr>
        <td>9001030</td>
        <td>一次查询页面ID数量不能超过50</td>
    </tr>
    <tr>
        <td>9001031</td>
        <td>时间区间不合法</td>
    </tr>
    <tr>
        <td>9001032</td>
        <td>保存设备与页面的绑定关系参数错误</td>
    </tr>
    <tr>
        <td>9001033</td>
        <td>门店ID不合法</td>
    </tr>
    <tr>
        <td>9001034</td>
        <td>设备备注信息过长</td>
    </tr>
    <tr>
        <td>9001035</td>
        <td>设备申请参数不合法</td>
    </tr>
    <tr>
        <td>9001036</td>
        <td>查询起始值begin不合法</td>
    </tr>
</table>

## 1.3 公众号接口接入指南
#### 第一步：填写服务器配置
登录微信公众平台官网后，在公众平台后台管理页面 - 开发者中心页，点击“修改配置”按钮，填写服务器地址（URL）、Token和EncodingAESKey，其中URL是开发者用来接收微信消息和事件的接口URL。Token可由开发者可以任意填写，用作生成签名（该Token会和接口URL中包含的Token进行比对，从而验证安全性）。EncodingAESKey由开发者手动填写或随机生成，将用作消息体加解密密钥。

同时，开发者可选择消息加解密方式：明文模式、兼容模式和安全模式。模式的选择与服务器配置在提交后都会立即生效，请开发者谨慎填写及选择。加解密方式的默认状态为明文模式，选择兼容模式和安全模式需要提前配置好相关加解密代码。

![img_config](https://cloud.githubusercontent.com/assets/13936823/19382977/0c6a9ff8-9235-11e6-869c-4342807c9ebc.png)

#### 第二步：验证服务器地址的有效性
开发者提交信息后，微信服务器将发送GET请求到填写的服务器地址URL上，GET请求携带四个参数：

<table>
    <tr>
        <td>参数</td>
        <td>描述</td>
    </tr>
    <tr>
        <td>signature</td>
        <td>微信加密签名，signature结合了开发者填写的token参数和请求中的timestamp参数、nonce参数</td>
    </tr>
    <tr>
        <td>timestamp</td>
        <td>时间戳</td>
    </tr>
    <tr>
        <td>nonce</td>
        <td>随机数</td>
    </tr>
    <tr>
        <td>echostr</td>
        <td>随机字符串</td>
    </tr>
</table>

开发者通过检验signature对请求进行校验（下面有校验方式）。若确认此次GET请求来自微信服务器，请原样返回echostr参数内容，则接入生效，成为开发者成功，否则接入失败。

加密/校验流程如下：
1. 将token、timestamp、nonce三个参数进行字典序排序
2. 将三个参数字符串拼接成一个字符串进行sha1加密
3. 开发者获得加密后的字符串可与signature对比，标识该请求来源于微信

#### 第三步：依据接口文档实现业务逻辑

验证URL有效性成功后即接入生效，成为开发者。如果公众号类型为服务号（订阅号只能使用普通消息接口），可以在公众平台网站中申请认证，认证成功的服务号将获得众多接口权限，以满足开发者需求。

此后用户每次向公众号发送消息、或者产生自定义菜单点击事件时，开发者填写的服务器配置URL将得到微信服务器推送过来的消息和事件，然后开发者可以依据自身业务逻辑进行响应，例如回复消息等。

公众号调用各接口时，一般会获得正确的结果，具体结果可见对应接口的说明。返回错误时，可根据返回码来查询错误原因。

用户向公众号发送消息时，公众号方收到的消息发送者是一个OpenID，是使用用户微信号加密后的结果，每个用户对每个公众号有一个唯一的OpenID。

此外，由于开发者经常有需在多个平台（移动应用、网站、公众帐号）之间共通用户帐号，统一帐号体系的需求，微信开放平台（open.weixin.qq.com）提供了UnionID机制。开发者可通过OpenID来获取用户基本信息，而如果开发者拥有多个应用（移动应用、网站应用和公众帐号，公众帐号只有在被绑定到微信开放平台帐号下后，才会获取UnionID），可通过获取用户基本信息中的UnionID来区分用户的唯一性，因为只要是同一个微信开放平台帐号下的移动应用、网站应用和公众帐号，用户的UnionID是唯一的。换句话说，同一用户，对同一个微信开放平台帐号下的不同应用，UnionID是相同的。详情请在微信开放平台的资源中心-移动应用开发-微信登录-授权关系接口调用指引-获取用户个人信息（UnionID机制）中查看。

另请注意，微信公众号接口只支持80接口。

## 1.4 公众号接口示例
### 1.4.1 自定义菜单
自定义菜单能够帮助公众号丰富界面，让用户更好更快地理解公众号的功能。开启自定义菜单后，公众号界面如图所示：
![img_menu](https://cloud.githubusercontent.com/assets/13936823/19382922/d42f3522-9234-11e6-8140-6f5bdc297f2f.PNG)

#### 请注意：

1、自定义菜单最多包括3个一级菜单，每个一级菜单最多包含5个二级菜单。
2、一级菜单最多4个汉字，二级菜单最多7个汉字，多出来的部分将会以“...”代替。
3、创建自定义菜单后，菜单的刷新策略是，在用户进入公众号会话页或公众号profile页时，如果发现上一次拉取菜单的请求在5分钟以前，就会拉取一下菜单，如果菜单有更新，就会刷新客户端的菜单。测试时可以尝试取消关注公众账号后再次关注，则可以看到创建后的效果。

自定义菜单接口可实现多种类型按钮，如下：

##### 1、click：点击推事件
用户点击click类型按钮后，微信服务器会通过消息接口推送消息类型为event	的结构给开发者（参考消息接口指南），并且带上按钮中开发者填写的key值，开发者可以通过自定义的key值与用户进行交互；
##### 2、view：跳转URL
用户点击view类型按钮后，微信客户端将会打开开发者在按钮中填写的网页URL，可与网页授权获取用户基本信息接口结合，获得用户基本信息。
##### 3、scancode_push：扫码推事件
用户点击按钮后，微信客户端将调起扫一扫工具，完成扫码操作后显示扫描结果（如果是URL，将进入URL），且会将扫码的结果传给开发者，开发者可以下发消息。
##### 4、scancode_waitmsg：扫码推事件且弹出“消息接收中”提示框
用户点击按钮后，微信客户端将调起扫一扫工具，完成扫码操作后，将扫码的结果传给开发者，同时收起扫一扫工具，然后弹出“消息接收中”提示框，随后可能会收到开发者下发的消息。
##### 5、pic_sysphoto：弹出系统拍照发图
用户点击按钮后，微信客户端将调起系统相机，完成拍照操作后，会将拍摄的相片发送给开发者，并推送事件给开发者，同时收起系统相机，随后可能会收到开发者下发的消息。
##### 6、pic_photo_or_album：弹出拍照或者相册发图
用户点击按钮后，微信客户端将弹出选择器供用户选择“拍照”或者“从手机相册选择”。用户选择后即走其他两种流程。
##### 7、pic_weixin：弹出微信相册发图器
用户点击按钮后，微信客户端将调起微信相册，完成选择操作后，将选择的相片发送给开发者的服务器，并推送事件给开发者，同时收起相册，随后可能会收到开发者下发的消息。
##### 8、location_select：弹出地理位置选择器
用户点击按钮后，微信客户端将调起地理位置选择工具，完成选择操作后，将选择的地理位置发送给开发者的服务器，同时收起位置选择工具，随后可能会收到开发者下发的消息。
##### 9、media_id：下发消息（除文本消息）
用户点击media_id类型按钮后，微信服务器会将开发者填写的永久素材id对应的素材下发给用户，永久素材类型可以是图片、音频、视频、图文消息。请注意：永久素材id必须是在“素材管理/新增永久素材”接口上传后获得的合法id。
##### 10、view_limited：跳转图文消息URL
用户点击view_limited类型按钮后，微信客户端将打开开发者在按钮中填写的永久素材id对应的图文消息URL，永久素材类型只支持图文消息。请注意：永久素材id必须是在“素材管理/新增永久素材”接口上传后获得的合法id。

### 1.4.2 接口调用请求说明

http请求方式：POST（请使用https协议）

http请求：https://api.weixin.qq.com/cgi-bin/menu/create?access_token=ACCESS_TOKEN

#### 参数说明
<table>
    <tr>
        <td>参数</td>
        <td>是否必读</td>
        <td>说明</td>
    </tr>
    <tr>
        <td>button</td>
        <td>是</td>
        <td>一级菜单数组，个数应为1~3个</td>
    </tr>
    <tr>
        <td>sub_button</td>
        <td>否</td>
        <td>二级菜单数组，个数应为1~5个</td>
    </tr>
    <tr>
        <td>type</td>
        <td>是</td>
        <td>菜单的响应动作类型</td>
    </tr>
    <tr>
        <td>name</td>
        <td>是</td>
        <td>菜单标题，不超过16个字节，子菜单不超过40个字节</td>
    </tr>
    <tr>
        <td>key</td>
        <td>click等点击类型必须</td>
        <td>菜单KEY值，用于消息接口推送，不超过128字节</td>
    </tr>
    <tr>
        <td>url</td>
        <td>view类型必须</td>
        <td>网页链接，用户点击菜单可打开链接，不超过1024字节</td>
    </tr>
    <tr>
        <td>media_id</td>
        <td>media_id类型和view_limited类型必须</td>
        <td>调用新增永久素材接口返回的合法media_id</td>
    </tr>
</table>

#### 返回结果

正确时的返回JSON数据包：
{"errcode":0,"errmsg":"ok"}

错误时的返回JSON数据包（示例为无效菜单名长度）：
{"errcode":40018,"errmsg":"invalid button name size"}

其它错误请参考1.2节：公众号接口返回码

### 1.4.3 本项目中的运作方式
#### 菜单配置的存储
菜单配置存储于数据库`t_4s_wx_menu`表中(表结构定义位于：`\mysql\20150109\20141001A_WeChat_Menu.sql`),表结构脚本如下:
```
CREATE TABLE IF NOT EXISTS t_4s_wx_menu(
    s4_id INT UNSIGNED NOT NULL COMMENT '4s店id',
    sn TINYINT UNSIGNED NOT NULL COMMENT '按16进制解析,如0x13表示第1个主菜单里的第3个子菜单',
    wx_type VARCHAR(32) COMMENT '微信菜单的响应动作类型 类型:click,view,scancode_push,scancode_waitmsg...,详情参考微信文档',
    wx_name VARCHAR(16) NOT NULL COMMENT '菜单标题,1级菜单至多4个汉字,2级菜单至多7个汉字',
    wx_key VARCHAR(128) COMMENT 'click类型菜单需要,最多128字节',
    wx_url VARCHAR(256) COMMENT 'view类型菜单需要,最多256字节',
    banner_img VARCHAR(256) COMMENT '定义菜单响应消息最顶部的一个图片URL,最多256字节',
    max_news TINYINT UNSIGNED DEFAULT '2' COMMENT '最多可附带显示的资讯信息的数量,默认为2',
    max_acts TINYINT UNSIGNED DEFAULT '2' COMMENT '最可多附带显示的活动信息的数量,默认为2',
    remark VARCHAR(256) COMMENT '备注说明',
    status TINYINT UNSIGNED DEFAULT '1' COMMENT '0禁用 1启用(默认值) 2仅DEV环境启用',
    PRIMARY KEY(s4_id, sn)
);
```
#### 菜单的注册
##### 1.`/web/package.json`项目依赖
项目启动后，程序会自动执行`\web\package.json`文件中的项目依赖，执行到`"start": "node server.js"`时，开始读取`\web\server.js`中的项目配置
```
{
  "name": "incar-website",
  "version": "1.0.1",
  "description": "InCar HTTP Website and Service API Server",
  "private": true,
  "scripts": {
    "start": "node server.js"
  },
  "dependencies": {
  ...
```
##### 2.`/web/server.js`项目配置
程序执行到`server.js`文件中的`app.get('delayedInitializer')()`后开始对微信公众号的配置项进行初始化
```
app.get('delayedInitializer')();

// Expose app
exports = module.exports = app;
```
##### 3.`/web/config/express.js`微信公众号初始化
`express.js`文件将初始化程序`delayedInitializer`指向了`promiseSrv.delayedInitializer`
```
    app.set('delayedInitializer', promiseSrv.delayedInitializer);

    app.use('/wservice/manual', multiPart({keepExtensions: true, uploadDir: './data/manual', limit:10*1024*1024}));
    app.use('/wservice/upload', multiPart({keepExtensions: true, uploadDir: './data/upload', limit:10*1024*1024}));
```
同时`express.js`文件中定义了`promiseSrv`文件路径
```
var promiseSrv = require('../srv/promiseSrv');
```
##### 4.`/web/srv/promiseSrv.js`执行初始化
`promiseSrv.js`文件由`/web/srv/promiseSrv`文件夹中的TypeScript文件编译而成，编译定义请查看`/web/gulpfile.js`文件对应代码：
```
...
gulp.task('ts-promiseSrv', ()=>{
    var tsResult = tsProjPromiseSrv.src()
        .pipe(newer('srv/promiseSrv.js'))
        .pipe(sourcemaps.init())
        .pipe(debug({ title: 'ts: ' }))
        .pipe(ts(tsProjPromiseSrv));
    return tsResult.js
        .pipe(sourcemaps.write('.', { sourceRoot: 'promiseSrv' }))
        .pipe(gulp.dest('srv/'))
        .pipe(debug({ title: 'out: ' }));
});
...
```
###### `promiseSrv.delayedInitializer`之后的程序流程图:
![incar_platform](https://cloud.githubusercontent.com/assets/13936823/19470875/c23edcec-9553-11e6-863c-a809abdd20a8.png)

## 1.5 微信公众平台开发者文档
#### 微信公众平台其它功能请查阅开发者文档：https://mp.weixin.qq.com/wiki/home/index.html

# 2.JS功能介绍
## activityDetailService.js
### 获取活动信息
<table>
    <tr>
        <td>方法名</td>
        <td>参数</td>
        <td>功能</td>
        <td>注释</td>
    </tr>
    <tr>
        <td>getActivityInfo</td>
        <td>
            req：请求<br>
            res：应答
        </td>
        <td>获取我的赛况</td>
        <td></td>
    </tr>
    <tr>
        <td>getActivityDetail</td>
        <td>
            req：请求<br>
            res：应答
        </td>
        <td>获取活动详情</td>
        <td></td>
    </tr>
    <tr>
        <td>searchInfo</td>
        <td>
            db：数据库连接<br>
            wx_oid：微信OpenID<br>
            act_id：活动ID<br>
            s4_id：4S店ID<br>
            tm_start：点火时间<br>
            tm_end：熄火时间<br>
            callback：回调<br>
        </td>
        <td>查询活动参与者信息</td>
        <td>供getActivityInfo方法调用</td>
    </tr>
    <tr>
        <td>search</td>
        <td>
            db：数据库连接<br>
            act_id：活动ID<br>
            callback：回调<br>
        </td>
        <td>查询活动信息</td>
        <td>供getActivityDetail方法调用</td>
    </tr>
</table>

## applyService.js
#### 报名参加活动
<table>
    <tr>
        <td>方法名</td>
        <td>参数</td>
        <td>功能</td>
        <td>注释</td>
    </tr>
    <tr>
        <td>applyActivity</td>
        <td>
            req：请求<br>
            res：应答
        </td>
        <td>报名活动</td>
        <td></td>
    </tr>
    <tr>
        <td>applyData</td>
        <td>
            db：数据库连接<br>
            openid：微信OpenID<br>
            sopenid：企业号ID<br>
            act_id：活动ID<br>
            tags：行为ID<br>
            callback：回调<br>
        </td>
        <td>修改活动参与者信息</td>
        <td>供applyActivity方法调用</td>
    </tr>
    <tr>
        <td>changeDate_1</td>
        <td>
            date：时间<br>
        </td>
        <td>时间格式转换</td>
        <td>供applyData方法调用</td>
    </tr>
</table>

## behaviorService.js
#### 获取驾驶习惯数据

## brandService.js
#### 获取品牌信息

## cancelOthersBookService.js
#### 取消维修预约

## cancelSlotBookingService.js
#### 取消预约

## cancelTrialrunService.js
#### 取消试驾预约

## carbonService.js
#### 获取碳排放量信息

## carTypeService.js
#### 获取车型信息

## driveRecordService.js
#### 查询行驶数据

## fuelService.js
### 获取油耗信息

## getOpenidService.js
#### 获取OpenID

## graphicCountService.js
#### 保存访问统计信息

## haoserviceAPI.js
#### 违章查询

## infoConfigService.js
#### 获取车辆相关信息

## lampService.js
#### 获取故障指示灯信息

## matchResultService.js
#### 获取4S店活动信息

## mservice.js
#### service配置

## my4sInfoService.js
#### 查询车主所在4S店相关信息

## myActivityService.js
#### 查询车主参加的活动信息

## myBookingService.js
##### 查询车主的预约信息

## myCareService.js
##### 查询车主的保养信息

## myDriveService.js
##### 查询车主的驾驶信息

## myOthersBookingService.js
#### 查询车主的其它预约信息

## myTrialrunService.js
#### 查询车主的试驾预约信息

## nodegrass.js
#### 配置

## othersbookingService.js
#### 维修预约

## seriesService.js
#### 查询车系信息

## slotBookingService.js
#### 保养预约

## sopenidService.js
#### 查询服务号相关信息

## trialrunService.js
#### 试驾预约

## userService.js
#### 获取用户相关信息

## weatherService.js
#### 获取天气信息
