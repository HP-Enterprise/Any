# 设备收发服务
设备收发服务用于接收来自OBD设备发送的数据，数据被解析后，存入数据库中，
有关位置的数据同时还被发送到阿里云的消息队列中供其它应用使用

![obd-receiver-server](https://camo.githubusercontent.com/71daf3c2ab6aea7bdc81be2f87552a716b8fba01/68747470733a2f2f646f63732e676f6f676c652e636f6d2f64726177696e67732f642f31444b577364594255376a7a6a32717a7334585a576c6a456b786c615643394f685a4c396b5f62344f7151302f7075623f773d34383026683d333630)

OBD设备安装在行驶中的汽车上，通常在不断的移动之中，数据通过GSM蜂窝网络通过TCP发送到服务器。
这个程序即是运行在服务器上的接受程序

## 依赖项
参见 package.json 文件，主要的几个依赖项如下：
+ @incar/landu-package 蓝度OBD设备的数据包解析模块
+ ali-mns 阿里云消息队列SDK
+ mysql MYSQL数据库操作模块

## 启动和监听过程 app.js
程序启动后，即监听TCP-9005端口，一旦收到数据包，就调用蓝度包解析模块对数据包进行合法性校验，并进行包头部的解析。
如果包不合法，那么就会被抛弃;反之，合法包会交给`worker308`进行后续处理

worker308对应于处理蓝度OBD的3.08版本数据；以前还有2.x版本，现今所有2.x的设备均已淘汰，因此worker2xx已经删除

当worker308处理完成后，会把应答数据包返回过来，应答数据包被通过TCP网络回发给设备。

由于OBD设备往往处于不断的移动之中，网络联接经常 并不可靠，因此OBD需要服务器给一个应答，以表明服务器已经确实
正确接收到了这个数据包。如果服务器不给应答，那么OBD会把信息一直储存在自己内部的SD卡中，过段时间后会自动重试。
如果服务器一直不给回应，OBD设备上的SD卡有可能会被占满

这种机制有一个好处，如果服务器短暂停止服务，数据并不会丢失，等服务恢复后，OBD设备会重发数据。
但这种机制也有相应的坏处，如果程序中有差错，总是不能给设备应答，那么导致设备大量的重发，容易造成拥堵

最后在发送完应答之后，合法包的原始数据十六进制的形式会记录在数据库中`worker.saveToHistory()`

## worker308
worker308入口点是`work.packetProcess(...)`

packetProcess直接根据commandWork【参见蓝度OBD数据协议】进入不同的处理过程

```javascript
if(commandWord===0x1601){
    packetProcess_1601(dataBuffer,saveAndReturn);
}
else if(commandWord===0x1602){
        packetProcess_1602(dataBuffer,saveAndReturn);
}
else if(commandWord===0x1603){
    packetProcess_1603(dataBuffer,saveAndReturn);
}
else if(commandWord===0x1605){
    packetProcess_1605(dataBuffer,saveAndReturn);
}
else if ...
```

几个主要的命令如下：
+ 0x1601 行驶统计信息，发动机点火或熄火时发送，运行中每隔一定时间也会发送，熄火几分钟后会再发最后一次
+ 0x1602 报警 出现异常状况时发送，比如 碰撞 电压低 故障报告 水温异常等等，另外，在拔下OBD后，重新插上会报告一个拔下告警
+ 0x1603 参数配置 可以配置上报服务器的IP端口，车辆品牌，排量等等
+ 0x1606 位置信息 GPS位置信息，间隔一定时间，或车辆运动一定距离后发送，同时，会向阿里云上的一个消息队列发送通知。电子围栏功能依赖这个功能。
+ 0x1608 怠速车况数据
+ 0x160A 驾驶行为数据 超速行驶 急加速等等
+ 0x1621 远程检测报告

# 远程诊断的流程
大多数情况下，OBD全自动工作，但远程诊断需要由操作人手动发起一个请求给OBD设备。
1. 当前这个请求是通过外部程序利用SMS短消息发送给OBD设备的
2. 如果设备满足进行远程诊断的条件，本程序会收到0x1621检测结果报告，
同时外部程序轮循数据库中相应车辆的结果报告
3. 如果外部程序轮循发现了结果报告，那么展示结果报告，否则要么重试，要么显示失败

以上步骤，只有第2步属于本程序处理范围，其它部分由外部程序处理

